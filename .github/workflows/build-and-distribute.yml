name: Build and Release macOS App

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (required for manual runs, e.g., v1.0.0)'
        required: false
        type: string

env:
  APP_NAME: "VTS"
  BUNDLE_ID: "com.voicetypestudio.app"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'

    - name: Setup Node.js (for create-dmg)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Make build script executable
      run: chmod +x scripts/build-dmg.sh

    # æž„å»º DMG (ä½¿ç”¨ Ad-hoc ç­¾å)
    - name: Build DMG
      env:
        APP_NAME: ${{ env.APP_NAME }}
        BUNDLE_ID: ${{ env.BUNDLE_ID }}
        # å³ä½¿æ²¡æœ‰ Secrets ä¹Ÿèƒ½è¿è¡Œ
        GITHUB_ACTIONS: true
        GITHUB_REF: ${{ github.ref }}
      run: ./scripts/build-dmg.sh

    - name: Extract version info
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${{ inputs.tag_name }}
        fi

        if [ -z "$VERSION" ]; then
          echo "âŒ No version specified"
          exit 1
        fi

        VERSION_NUMBER=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: ${{ env.APP_NAME }} ${{ steps.get_version.outputs.version_number }}
        draft: false
        prerelease: false
        files: |
          ${{ env.APP_NAME }}-${{ steps.get_version.outputs.version_number }}-Universal.dmg
          checksums.txt
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Homebrew Tap
      env:
        # å¿…é¡»åœ¨ä»“åº“ Secrets ä¸­é…ç½®æ­¤ Token
        TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        VERSION_NUMBER: ${{ steps.get_version.outputs.version_number }}
        VERSION_TAG: ${{ steps.get_version.outputs.version }}
        APP_NAME: ${{ env.APP_NAME }}
        GITHUB_USER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        echo "ðŸº Updating Homebrew Tap..."

        if [ -z "$TAP_TOKEN" ]; then
          echo "âš ï¸ HOMEBREW_TAP_TOKEN secret is missing. Skipping Homebrew update."
          echo "Please add it to Settings > Secrets and variables > Actions"
          exit 0
        fi

        # 1. è®¡ç®— SHA256
        DMG_FILE="${APP_NAME}-${VERSION_NUMBER}-Universal.dmg"
        SHA256=$(shasum -a 256 "$DMG_FILE" | awk '{print $1}')
        echo "File: $DMG_FILE"
        echo "SHA256: $SHA256"

        # 2. æ‹‰å– Tap ä»“åº“
        git clone "https://$GITHUB_USER:$TAP_TOKEN@github.com/$GITHUB_USER/homebrew-tap.git" tap-repo
        cd tap-repo

        # é…ç½® Git
        git config user.name "GitHub Action"
        git config user.email "action@github.com"

        # 3. åˆ›å»º Casks ç›®å½•
        mkdir -p Casks

        # 4. ç”Ÿæˆ Cask æ–‡ä»¶ (Ruby è¯­æ³•)
        # æ³¨æ„ï¼šCask çš„ token å¿…é¡»æ˜¯å…¨å°å†™ã€çŸ­æ¨ªçº¿è¿žæŽ¥
        CASK_TOKEN="vts"

        cat > Casks/$CASK_TOKEN.rb <<EOF
        cask "$CASK_TOKEN" do
          version "$VERSION_NUMBER"
          sha256 "$SHA256"

          url "https://github.com/$GITHUB_USER/$REPO_NAME/releases/download/$VERSION_TAG/$DMG_FILE"
          name "VTS"
          name "Voice Typing Studio"
          desc "Open-source macOS dictation replacement with AI-powered transcription"
          homepage "https://github.com/$GITHUB_USER/$REPO_NAME"

          app "VTS.app"

          zap trash: [
            "~/Library/Preferences/com.voicetypestudio.app.plist",
            "~/Library/Caches/com.voicetypestudio.app",
            "~/Library/Application Support/VTS"
          ]
        end
        EOF

        # 5. æäº¤å¹¶æŽ¨é€
        git add Casks/$CASK_TOKEN.rb

        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to Cask file."
        else
          git commit -m "Update VTS to $VERSION_NUMBER"
          git push
          echo "âœ… Successfully updated Homebrew Tap!"
        fi
