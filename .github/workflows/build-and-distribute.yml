name: Build and Release macOS App

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name (required for manual runs, e.g., v1.0.0)'
        required: false
        type: string

env:
  APP_NAME: "VTS"
  BUNDLE_ID: "com.voicetypestudio.app"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'

    - name: Setup Node.js (for create-dmg)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Make build script executable
      run: chmod +x scripts/build-dmg.sh

    # 构建 DMG (使用 Ad-hoc 签名)
    - name: Build DMG
      env:
        APP_NAME: ${{ env.APP_NAME }}
        BUNDLE_ID: ${{ env.BUNDLE_ID }}
        # 即使没有 Secrets 也能运行
        GITHUB_ACTIONS: true
        GITHUB_REF: ${{ github.ref }}
      run: ./scripts/build-dmg.sh

    - name: Extract version info
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=${{ inputs.tag_name }}
        fi

        if [ -z "$VERSION" ]; then
          echo "❌ No version specified"
          exit 1
        fi

        VERSION_NUMBER=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: ${{ env.APP_NAME }} ${{ steps.get_version.outputs.version_number }}
        draft: false
        prerelease: false
        files: |
          ${{ env.APP_NAME }}-${{ steps.get_version.outputs.version_number }}-Universal.dmg
          checksums.txt
        token: ${{ secrets.GITHUB_TOKEN }}
